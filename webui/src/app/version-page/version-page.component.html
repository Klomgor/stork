<app-breadcrumbs [items]="breadcrumbs">
    <div page-help>
        <p>
            This page displays information about current versions of ISC software that may be used in your Stork
            deployment. Below you can find summary of ISC software found on your machines.
        </p>
    </div>
</app-breadcrumbs>
<div class="max-w-100rem">
    <div class="flex flex-wrap gap-2 justify-content-between mb-3">
        <p-messages
            styleClass="max-w-50rem header-message"
            *ngIf="showAlert$ | async"
            [escape]="false"
            [enableService]="false"
            (onClose)="dismissAlert()"
            [value]="[
                {
                    summary: 'Action required',
                    severity: 'warn',
                    detail: 'Stork has detected ISC software version in use that requires your attention. Please review below Summary table.',
                },
            ]"
        ></p-messages>
        <p-messages
            styleClass="max-w-50rem header-message"
            *ngIf="isOfflineData$ | async"
            [escape]="false"
            [enableService]="false"
            [value]="[
                {
                    summary: 'Note',
                    severity: 'info',
                    detail:
                        'Below information about ISC software versions relies on a data that was generated on ' +
                        (dataDate$ | async) +
                        '. To see up-to-date information, please visit the <a href=\'https:\/\/www.isc.org\'>ISC webpage</a>.',
                },
            ]"
        ></p-messages>
        <p-messages
            *ngIf="errorOccurred"
            [value]="[
                {
                    summary: 'Error while fetching data!',
                    severity: 'error',
                    detail: 'Error occurred while retrieving software versions data from Stork server!',
                },
            ]"
            styleClass="max-w-50rem header-message"
            [enableService]="false"
        ></p-messages>
        <p-button
            *ngIf="!errorOccurred"
            styleClass="flex-none"
            label="Refresh Versions"
            icon="pi pi-refresh"
            (onClick)="refreshVersions()"
        ></p-button>
    </div>
    <!-- to be used in the future: Stork server couldn't connect to ISC GitLab to retrieve the latest data about recent software versions. -->
    <p-panel header="Summary of ISC software versions detected by Stork" styleClass="mt-3">
        <p-table
            [value]="machines"
            styleClass="p-datatable-striped"
            responsiveLayout="stack"
            [breakpoint]="'48rem'"
            id="summary-table"
            rowGroupMode="subheader"
            groupRowsBy="versionCheckSeverity"
            sortField="versionCheckSeverity"
            sortMode="single"
            [tableStyle]="{ 'min-width': '15rem' }"
            [loading]="summaryDataLoading"
        >
            >
            <ng-template pTemplate="header">
                <tr>
                    <th>Hostname</th>
                    <th>Location</th>
                    <th>Agent Version</th>
                    <th>App(s) Version</th>
                    <th>Summary</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="groupheader" let-m let-expanded="expanded">
                <tr>
                    <td colspan="5" class="row-toggle">
                        <div class="flex align-items-center">
                            <button
                                type="button"
                                pButton
                                pRipple
                                [pRowToggler]="m"
                                class="p-button-text p-button-rounded p-button-plain mr-2 flex-none"
                                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                            ></button>
                            <p-badge
                                [value]="counters[m.versionCheckSeverity]"
                                [severity]="
                                    m.versionCheckSeverity === Severity.warn
                                        ? 'warning'
                                        : m.versionCheckSeverity === Severity.error
                                          ? 'danger'
                                          : Severity[m.versionCheckSeverity]
                                "
                                styleClass="flex-none mr-2"
                            ></p-badge>
                            <p-messages
                                [value]="[
                                    {
                                        severity: Severity[m.versionCheckSeverity],
                                        summary: getGroupHeaderMessage(m.versionCheckSeverity, dataDate$ | async),
                                    },
                                ]"
                                [closable]="false"
                                [enableService]="false"
                                styleClass="max-w-30rem"
                            ></p-messages>
                        </div>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="rowexpansion" let-m>
                <tr>
                    <td>
                        <span class="p-column-title">Hostname</span>
                        <a routerLink="/machines/{{ m.id }}">{{ m.hostname || m.address }}</a>
                    </td>
                    <td><span class="p-column-title">Location</span>{{ m.address }}:{{ m.agentPort }}</td>
                    <td>
                        <span class="p-column-title">Agent Version</span>
                        {{ m.agentVersion }}
                    </td>
                    <td>
                        <span class="p-column-title">App(s) Version</span>
                        <ng-container *ngFor="let a of m.apps; let i = index"
                            ><br *ngIf="i > 0" />{{ a.type === 'bind9' ? '' : (a.type | titlecase) }}
                            {{ a.version }}</ng-container
                        >
                    </td>
                    <td>
                        <span class="p-column-title">Summary</span>
                        <ng-container *ngFor="let a of m.apps">
                            <ng-container *ngIf="a.details?.mismatchingDaemons">
                                <p-messages
                                    [value]="[
                                        {
                                            summary: 'Kea daemons versions mismatch!',
                                            severity: 'error',
                                            detail:
                                                'Kea <a href=\'/apps/kea/' +
                                                a.id +
                                                '\'>' +
                                                a.name +
                                                '</a> daemons use mismatching versions:<br>' +
                                                (getDaemonsVersions(a) | uppercase) +
                                                '.<br>All daemons should have the same version!',
                                        },
                                    ]"
                                    styleClass="max-w-50rem"
                                    [enableService]="false"
                                    [closable]="false"
                                    [escape]="false"
                                ></p-messages>
                            </ng-container>
                            <app-version-status
                                [app]="a.type"
                                [version]="a.version"
                                [showAppName]="true"
                                [inline]="false"
                                styleClass="max-w-50rem"
                            ></app-version-status
                        ></ng-container>
                        <app-version-status
                            app="stork"
                            [version]="m.agentVersion"
                            [showAppName]="true"
                            [inline]="false"
                            styleClass="max-w-50rem"
                        ></app-version-status>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="5">No data retrieved from Stork server.</td>
                </tr>
            </ng-template>
        </p-table>
    </p-panel>
    <p-panel header="Kea current releases" styleClass="mt-3">
        <p-table [value]="keaVersions" styleClass="p-datatable-striped" [loading]="swVersionsDataLoading">
            <ng-template pTemplate="header">
                <tr>
                    <th>Version</th>
                    <th>Status</th>
                    <th>Documentation</th>
                    <th>Release date</th>
                    <th>EoL Date</th>
                    <th>Download</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-v>
                <tr>
                    <td>{{ v.version }}</td>
                    <td>{{ v.status }}</td>
                    <td>
                        Kea ARM (<a href="https://kea.readthedocs.io/en/kea-{{ v.version }}/" target="_blank">HTML</a>)
                        <br />
                        Release Notes (<a
                            href="https://downloads.isc.org/isc/kea/{{ v.version }}/Kea-{{
                                v.version
                            }}-ReleaseNotes.txt"
                            target="_blank"
                            >TXT</a
                        >)
                    </td>
                    <td>
                        {{ v.releaseDate | date: 'MMMM YYYY' }}
                    </td>
                    <td>
                        {{ v.eolDate | date: 'MMMM YYYY' }}
                    </td>
                    <td>
                        Download (<a
                            target="_blank"
                            href="https://cloudsmith.io/~isc/repos/kea-{{
                                v.status === 'Development' ? 'dev' : v.major + '-' + v.minor
                            }}/packages/"
                            >Packages</a
                        ><a
                            target="_blank"
                            class="ml-2"
                            href="https://dl.cloudsmith.io/public/isc/kea-{{
                                v.status === 'Development' ? 'dev' : v.major + '-' + v.minor
                            }}/raw/versions/{{ v.version }}/kea-{{ v.version }}.tar.gz"
                            >Tarball</a
                        >)
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="6">No data retrieved from Stork server.</td>
                </tr>
            </ng-template>
        </p-table>
    </p-panel>
    <p-panel header="BIND 9 current releases" styleClass="mt-3">
        <p-table [value]="bind9Versions" styleClass="p-datatable-striped" [loading]="swVersionsDataLoading">
            <ng-template pTemplate="header">
                <tr>
                    <th>Version</th>
                    <th>Status</th>
                    <th>Documentation</th>
                    <th>Release date</th>
                    <th>EoL Date</th>
                    <th>Download</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-v>
                <tr>
                    <td>{{ v.version }}</td>
                    <td>{{ v.status }}<ng-container *ngIf="v.esv">, ESV</ng-container></td>
                    <td>
                        BIND {{ v.major + '.' + v.minor }} ARM (<a
                            href="https://bind9.readthedocs.io/en/v{{ v.version }}/"
                            target="_blank"
                            >HTML</a
                        >)
                        <br />
                        Release Notes (<a
                            href="https://downloads.isc.org/isc/bind9/{{ v.version }}/RELEASE-NOTES-bind-{{
                                v.version
                            }}.html"
                            target="_blank"
                            >HTML</a
                        >)
                    </td>
                    <td>
                        {{ v.releaseDate | date: 'MMMM YYYY' }}
                    </td>
                    <td>
                        {{ v.eolDate | date: 'MMMM YYYY' }}
                    </td>
                    <td>
                        Download (<a href="https://kb.isc.org/docs/isc-packages-for-bind-9" target="_blank">Packages</a
                        ><a
                            target="_blank"
                            class="ml-2"
                            href="https://downloads.isc.org/isc/bind9/{{ v.version }}/bind-{{ v.version }}.tar.xz"
                            >Tarball</a
                        >)
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="6">No data retrieved from Stork server.</td>
                </tr>
            </ng-template>
        </p-table>
    </p-panel>
    <p-panel header="Stork current releases" styleClass="mt-3">
        <p-table [value]="storkVersions" styleClass="p-datatable-striped" [loading]="swVersionsDataLoading">
            <ng-template pTemplate="header">
                <tr>
                    <th>Version</th>
                    <th>Status</th>
                    <th>Documentation</th>
                    <th>Release date</th>
                    <th>EoL Date</th>
                    <th>Download</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-v>
                <tr>
                    <td>{{ v.version }}</td>
                    <td>{{ v.status }}</td>
                    <td>
                        Stork ARM (<a href="https://stork.readthedocs.io/en/v{{ v.version }}/" target="_blank">HTML</a>)
                        <br />
                        Release Notes (<a
                            href="https://downloads.isc.org/isc/stork/{{ v.version }}/Stork-{{
                                v.version
                            }}-ReleaseNotes.txt"
                            target="_blank"
                            >TXT</a
                        >)
                    </td>
                    <td>
                        {{ v.releaseDate | date: 'MMMM YYYY' }}
                    </td>
                    <td>
                        {{ v.eolDate | date: 'MMMM YYYY' }}
                    </td>
                    <td>
                        Download (<a href="https://cloudsmith.io/~isc/repos/stork/groups/" target="_blank">Packages</a
                        ><a
                            target="_blank"
                            class="ml-2"
                            href="https://downloads.isc.org/isc/stork/{{ v.version }}/stork-{{ v.version }}.tar.gz"
                            >Tarball</a
                        >)
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="6">No data retrieved from Stork server.</td>
                </tr>
            </ng-template>
        </p-table>
    </p-panel>
</div>
