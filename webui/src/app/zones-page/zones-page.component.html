<app-breadcrumbs [items]="breadcrumbs">
    <div page-help>
        <p>This page displays a list of DNS zones.</p>
    </div>
</app-breadcrumbs>

<p-tabView (onClose)="onTabClose($event)" [(activeIndex)]="activeIdx" (activeIndexChange)="onActiveIndexChange($event)">
    <p-tabPanel header="Zones">
        <p-fieldset legend="Actions">
            <div class="flex mb-2 gap-2 justify-content-end">
                <p-button label="Check Zone Inventory State" (onClick)="getZoneInventoryState()" />
                <p-button label="Feed Zone Inventories" (onClick)="fetchZones()" />
                <p-button
                    label="Get Zones"
                    (onClick)="zonesTable.onLazyLoad.emit(zonesTable.createLazyLoadMetadata())"
                />
            </div>
        </p-fieldset>
        <p-fieldset legend="Zones Inventory State">
            <p class="m-0">
                <p-table
                    [value]="zoneInventoryStates"
                    [paginator]="true"
                    [rows]="10"
                    [rowsPerPageOptions]="[10, 30, 100]"
                    [totalRecords]="zoneInventoryTotal"
                    [loading]="inventoryLoading"
                >
                    <ng-template pTemplate="header">
                        <tr>
                            <th>App</th>
                            <th>Daemon ID</th>
                            <th>Zone Count</th>
                            <th>Status</th>
                            <th>Error</th>
                            <th>Created at</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-state>
                        <tr>
                            <td>
                                <a routerLink="/apps/bind9/{{ state.appId }}">{{ state.appName }}</a>
                            </td>
                            <td>{{ state.daemonId }}</td>
                            <td>{{ state.zoneCount || 'n/a' }}</td>
                            <td>
                                <p-tag
                                    value="{{ state.status === 'erred' ? 'Error' : (state.status | titlecase) }} "
                                    [severity]="getSeverity(state.status)"
                                    [pTooltip]="getTooltip(state.status)"
                                />
                            </td>
                            <td>
                                <p-message
                                    *ngIf="state.error"
                                    severity="error"
                                    [text]="getErrorMessage(state.error)"
                                ></p-message>
                            </td>
                            <td>{{ state.createdAt | date: dateTimeFormat | placeholder: 'never' }}</td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="6">There is no Zones Inventory State fetched yet.</td>
                        </tr>
                    </ng-template>
                </p-table>
            </p>
        </p-fieldset>
        <p-table
            #zonesTable
            [value]="zones"
            [lazyLoadOnInit]="true"
            [lazy]="true"
            (onLazyLoad)="onLazyLoadZones($event)"
            [paginator]="true"
            [rows]="10"
            [rowsPerPageOptions]="[10, 30, 100]"
            [showCurrentPageReport]="true"
            stateStorage="session"
            [stateKey]="stateKey"
            currentPageReportTemplate="{currentPage} of {totalPages} pages"
            styleClass="p-datatable-striped"
            dataKey="id"
            [expandedRowKeys]="expandedRows"
            [loading]="zonesLoading"
            [totalRecords]="zonesTotal"
        >
            <ng-template pTemplate="header">
                <tr>
                    <th class="w-5rem"></th>
                    <th>Zone Name</th>
                    <th>Zone RName</th>
                    <th>Info</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-zone let-expanded="expanded">
                <tr>
                    <td>
                        <p-button
                            type="button"
                            pRipple
                            [pRowToggler]="zone"
                            [text]="true"
                            [rounded]="true"
                            [plain]="true"
                            [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                        />
                    </td>
                    <td>
                        <p-button [label]="zone.name" [link]="true" (click)="openTab(zone)" />
                    </td>
                    <td>{{ zone.rname }}</td>
                    <td>Zone has {{ zone.localZones.length }} local zones</td>
                </tr>
            </ng-template>
            <ng-template pTemplate="rowexpansion" let-zone>
                <tr>
                    <td colspan="4">
                        <div class="p-2">
                            <p-table
                                [value]="zone.localZones"
                                dataKey="serial"
                                [paginator]="true"
                                [rows]="10"
                                [rowsPerPageOptions]="[10, 30, 100]"
                            >
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th>App</th>
                                        <th>Class</th>
                                        <th>Daemon ID</th>
                                        <th>View</th>
                                        <th>Zone type</th>
                                        <th>Serial</th>
                                        <th>Loaded at</th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-localZone>
                                    <tr>
                                        <td>
                                            <a routerLink="/apps/bind9/{{ localZone.appId }}">{{
                                                localZone.appName
                                            }}</a>
                                        </td>
                                        <td>{{ localZone._class }}</td>
                                        <td>{{ localZone.daemonId }}</td>
                                        <td>{{ localZone.view }}</td>
                                        <td>{{ localZone.zoneType }}</td>
                                        <td>{{ localZone.serial }}</td>
                                        <td>{{ localZone.loadedAt | date: dateTimeFormat | placeholder: 'never' }}</td>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="emptymessage">
                                    <tr>
                                        <td colspan="7">There are no local zones for this zone.</td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="4">No zones found.</td>
                </tr>
            </ng-template>
            <ng-template pTemplate="paginatorright" let-paginatorState>
                Total: {{ paginatorState.totalRecords | pluralize: 'zone' }}
            </ng-template>
        </p-table>
    </p-tabPanel>
    <p-tabPanel *ngFor="let tab of openTabs" [header]="tab.name" [closable]="true">
        <p>
            Zone name:
            {{ tab.name }}
        </p>
        <p>
            Zone rname:
            {{ tab.rname }}
        </p>
        <p-table
            [value]="tab.localZones"
            dataKey="serial"
            [paginator]="true"
            [rows]="10"
            [rowsPerPageOptions]="[10, 30, 100]"
        >
            <ng-template pTemplate="header">
                <tr>
                    <th>App</th>
                    <th>Class</th>
                    <th>Daemon ID</th>
                    <th>View</th>
                    <th>Zone type</th>
                    <th>Serial</th>
                    <th>Loaded at</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-localZone>
                <tr>
                    <td>
                        <a routerLink="/apps/bind9/{{ localZone.appId }}">{{ localZone.appName }}</a>
                    </td>
                    <td>{{ localZone._class }}</td>
                    <td>{{ localZone.daemonId }}</td>
                    <td>{{ localZone.view }}</td>
                    <td>{{ localZone.zoneType }}</td>
                    <td>{{ localZone.serial }}</td>
                    <td>{{ localZone.loadedAt | date: dateTimeFormat | placeholder: 'never' }}</td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="7">There are no local zones for this zone.</td>
                </tr>
            </ng-template>
        </p-table>
    </p-tabPanel>
</p-tabView>
